(function(a){if(typeof define==="function"&&define.amd){define(["jquery","underscore","backbone"],a)}else{a(this.$,this._,this.Backbone)}}(function(e,n,m){function j(p){p=""+p||"local";if(!chrome.storage[p]){console.warn("Unknown type %s, defaulting to local",p);p="local"}this.type=p;this.storage=chrome.storage[this.type]}function i(p){return function(){var q=chrome.runtime.lastError;if(!q){p.resolve.apply(p,arguments)}else{console.warn("chromeStorage error: '%s'",q.message);p.reject(p,q.message,q)}}}function l(p){return function(r){var q=e.Deferred();if(typeof r==="function"){q.done(r)}this.storage[p](i(q));return q.promise()}}function k(p){return function(s,r){var q=e.Deferred();if(typeof r==="function"){q.done(r)}this.storage[p](s,i(q));return q.promise()}}n(j.prototype).extend({getBytesInUse:l("getBytesInUse"),clear:l("clear"),get:k("get"),set:k("set"),remove:k("remove"),getQuotaObject:function(){return n(this.storage).pick("QUOTA_BYTES","QUOTA_BYTES_PER_ITEM","MAX_ITEMS","MAX_SUSTAINED_WRITE_OPERATIONS_PER_MINUTE","MAX_WRITE_OPERATIONS_PER_HOUR")}});function g(p,q){n.bindAll(this);this.name=p;this.type=q||g.defaultType||"local";this.store=new j(this.type);this.loaded=this.store.get(this.name).pipe(this._parseRecords).done((function(r){this.records=r;chrome.storage.onChanged.addListener(b.bind(this))}).bind(this))}function b(r,q){var p=r[this.name];if(o(p,q)){h(p.newValue)}}function o(p,q){return;q===this.type&&p&&p.newValue!==a()}function h(p){this.records=p.split(",")}function a(){return this.records.join(",")}g.defaultType="local";function c(p){return function(){return p.toJSON()}}function f(){return(((1+Math.random())*65536)|0).toString(16).substring(1)}function d(){return(f()+f()+"-"+f()+"-"+f()+"-"+f()+"-"+f()+f()+f())}n(g.prototype).extend({create:function(p){if(!p.id){p.id=d();p.set(p.idAttribute,p.id)}return this.store.set(this._wrap(p),this._created.bind(this,p)).pipe(c(p))},_created:function(p){this.records.push(""+p.id);this.save()},update:function(p){return this.store.set(this._wrap(p),this._updated.bind(this,p)).pipe(c(p))},_updated:function(p){var q=""+p.id;if(!n(this.records).include(q)){this.records.push(q);this.save()}},find:function(p){return this.store.get(this._wrap(p)).pipe(this._found.bind(this,p))},_found:function(q,p){return JSON.parse(p[this._idOf(q)])},findAll:function(){var p=e.Deferred(),q=p.resolve.bind(p);e.when(this.loaded).done((function(r){var s=this._getRecordIds();this.store.get(s,q)}).bind(this));return p.pipe(this._foundAll)},_foundAll:function(p){return n(p).map(JSON.parse)},destroy:function(p){return this.store.remove(this._idOf(p),this._destroyed.bind(this,p)).pipe(c(p))},_destroyed:function(p){this.records=n.without(this.records,p.id);this.save()},quota:function(){var p=this.store.getQuotaObject();return this.store.getBytesInUse().pipe(function(q){return n(p).extend({QUOTA_BYTES_IN_USE:q})})},save:function(){var p={};p[this.name]=this.records.join(",");this.store.set(p)},_getRecordIds:function(){return this.records.map(this._idOf)},_idOf:function(p){return this.name+"-"+(n.isString(p)?p:p.id)},_wrap:function(p){var q={};q[this._idOf(p)]=JSON.stringify(p);return q},_parseRecords:function(p){if(p&&p[this.name]&&n.isString(p[this.name])){return p[this.name].split(",")}else{return[]}}});m.ChromeStorage=g;m.ChromeStorage.Wrapper=j;m.ChromeStorage.sync=m.chromeSync=function(w,t,s,r){var q=t.chromeStorage||t.collection.chromeStorage,v,p=n.isFunction;switch(w){case"read":v=t.id!=null?q.find(t):q.findAll();break;case"create":v=q.create(t);break;case"update":v=q.update(t);break;case"delete":v=q.destroy(t);break;default:var u=new Error('Unknown Method: "'+w+'"');v=e.Deferred();v.reject(v,u.message,u)}if(p(s.success)){v.done(s.success)}if(p(s.error)){v.fail(s.error)}if(p(r)){v.fail(s.error)}return v&&v.promise()};m.ajaxSync=m.sync;m.getSyncMethod=function(p){if(p.chromeStorage||(p.collection&&p.collection.chromeStorage)){return m.ChromeStorage.sync}else{return m.ajaxSync}};m.sync=function(s,r,q,p){return m.getSyncMethod(r).apply(this,[s,r,q,p])};return g}));
